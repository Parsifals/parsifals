 <!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§ßÂØåÁøÅÊ∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        .game-container {
            display: flex;
            width: 100%;
            height: 100vh;
            padding: 10px;
            gap: 10px;
        }

        .left-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        

        .game-log-mini {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            width: 250px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .game-log-mini h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }

        .log-item-mini {
            font-size: 11px;
            padding: 4px 0;
            color: #666;
            border-bottom: 1px solid #f0f0f0;
        }

        .log-item-mini:last-child {
            border-bottom: none;
        }

        .main-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .board-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        .current-player-box {
            display: flex;
            width: 200px;
            max-height: 60px;
            background: white;
            border-radius: 12px;
            padding: 10px;
            margin: auto auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10;
            
            overflow-y: auto;
        }

        .player-badge {
            align-items: center;
            font-size: 16px;
            padding: 8px 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .board {
            width: 95%;
            height: 95%;
            max-width: 1000px;
            max-height: 1000px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            grid-template-rows: repeat(11, 1fr);
            padding: 10px;
            gap: 4px;
            position: relative;
        }

        .board-center {
            grid-column: 2 / 11;
            grid-row: 2 / 11;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }

        .board-title {
            font-size: 56px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .dice-control {
            background: white;
            border-radius: 12px;
            padding: 15px 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .dice-count-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dice-count-btn {
            width: 45px;
            height: 45px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dice-count-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .dice-count-btn:hover {
            transform: scale(1.1);
        }

        .dice-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 35px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .dice-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .dice-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .space {
            border: 2px solid #ddd;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            padding: 4px;
            position: relative;
            transition: all 0.3s;
            background: white;
            cursor: pointer;
        }

        .space:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 50;
        }

        .space.corner {
            font-size: 14px;
            font-weight: bold;
        }

        .space.chance {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        .space.destiny {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        }

        .space.start {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }

        .space.airport, .space.train, .space.ship, .space.power {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }

        .space.jail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }

        .space.prison {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
        }

        .space.property.full-set {
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0%, 100% {
                box-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
                filter: brightness(1.1);
            }
            50% {
                box-shadow: 0 0 30px currentColor, 0 0 60px currentColor;
                filter: brightness(1.3);
            }
        }

        .color-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            border-radius: 4px 4px 0 0;
        }

        .space-name {
            font-size: 17px;
            line-height: 1.1;
            margin-top: 10px;
            margin-bottom: 2px;
        }

        .space-price {
            font-size: 12px;
            color: #666;
        }

        .level-badge {
            position: absolute;
            bottom: 3px;
            right: 3px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .player-piece {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
            z-index: 100;
        }

        .player-piece.active {
            z-index: 200;
            transform: scale(1.4);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .player-piece.in-jail {
            opacity: 0.6;
            border-color: #ef4444;
        }

        .dice-animation {
            position: absolute;
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            animation: diceRoll 0.5s ease-in-out;
            z-index: 1000;
        }

        @keyframes diceRoll {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.2); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.2); }
        }

        .players-panel {
            width: 360px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .panel-header h2 {
            font-size: 24px;
            color: #333;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .reset-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .player-card {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            border-left: 5px solid;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .player-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .player-card.active {
            box-shadow: 0 0 0 3px;
            transform: translateX(5px);
        }

        .player-card.bankrupt {
            opacity: 0.5;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .player-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .avatar:hover {
            transform: scale(1.1);
        }

        .player-name {
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .player-name:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .player-right {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            padding: 4px 10px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .status-tag {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }

        .bankrupt-tag {
            background: #ef4444;
            color: white;
        }

        .jail-tag {
            background: #f59e0b;
            color: white;
        }

        .pass-tag {
            background: #10b981;
            color: white;
        }

        .player-stats {
            margin-top: 12px;
            font-size: 14px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            color: #666;
        }

        .properties-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .property-chip {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4);
            animation: modalPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 400px;
            max-width: 500px;
            position: relative;
        }

        @keyframes modalPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .modal-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .modal-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
            white-space: pre-line;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn-cancel {
            background: #e5e7eb;
            color: #374151;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .celebration {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: fall 3s linear;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .tooltip-row {
            margin: 4px 0;
        }

        .cheat-btn {
            position: fixed;
            bottom: 20px;
            right: 380px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 999;
        }

        .cheat-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .cheat-panel {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 380px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 320px;
            max-height: 600px;
            overflow-y: auto;
        }

        .cheat-panel.show {
            display: block;
        }

        .cheat-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .cheat-dice-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .cheat-dice-btn {
            width: 100%;
            height: 45px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .cheat-dice-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .cheat-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .cheat-label {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #666;
        }

        .cheat-select, .cheat-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .cheat-apply-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .cheat-apply-btn:hover {
            transform: translateY(-2px);
        }

        .color-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .color-picker-modal.show {
            display: flex;
        }

        .color-picker-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .color-picker-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 4px solid transparent;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .color-option:hover {
            transform: scale(1.15);
        }

        .color-option.selected {
            border-color: #333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .game-started .btn-add,
        .game-started .btn-delete,
        .game-started .avatar,
        .game-started .player-name {
            pointer-events: none;
            opacity: 0.5;
        }

        .space.clickable {
            cursor: pointer;
            border: 3px solid #667eea;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- ‰∏ªÊ∏∏ÊàèÂå∫Âüü -->
        <div class="main-area">
            
            <div class="board-wrapper">
                
                <div class="game-log-mini">
                    <h4>üìã Ê∏∏ÊàèÊó•Âøó</h4>
                    <div id="logContent"></div>
                </div>
                <div class="board" id="gameBoard">
                    
                    <div class="board-center">
                        <div class="board-title">Â§ßÂØåÁøÅ</div>
                        <p style="color: #999; font-size: 20px;">Monopoly</p>
                    </div>
                </div>

                <div class="dice-control" id="diceControl" style="display: none;">
                    <div class="current-player-box" id="currentPlayerBox" style="display: none;">
                    <div class="player-badge" id="currentPlayerBadge"></div>
                </div>
                    <div class="dice-count-selector">
                        <span style="font-weight: bold; color: #666; font-size: 16px;">È™∞Â≠ê:</span>
                        <button class="dice-count-btn active" onclick="selectDiceCount(1)">1</button>
                        <button class="dice-count-btn" onclick="selectDiceCount(2)">2</button>
                    </div>
                    <button class="dice-btn" id="diceBtn" onclick="rollDice()">üé≤ Êé∑È™∞Â≠ê</button>
                </div>
            </div>
        </div>

        <!-- Âè≥‰æßÁé©ÂÆ∂Èù¢Êùø -->
        <div class="players-panel" id="playersPanel">
            <div class="panel-header">
                <h2>üë• Áé©ÂÆ∂</h2>
                <div class="header-buttons">
                    <button class="btn reset-btn" onclick="resetGame()">üîÑ</button>
                    <button class="btn btn-add" onclick="addPlayer()" id="addBtn">+</button>
                    <button class="btn btn-start" onclick="startGame()" id="startBtn">ÂºÄÂßã</button>
                </div>
            </div>
            <div id="playersList"></div>
        </div>
    </div>

    <!-- È¢úËâ≤ÈÄâÊã©Âô® -->
    <div class="color-picker-modal" id="colorPickerModal">
        <div class="color-picker-content">
            <div class="color-picker-title">ÈÄâÊã©È¢úËâ≤</div>
            <div class="color-grid" id="colorGrid"></div>
        </div>
    </div>

    <!-- ÂºπÁ™ó -->
    <div class="modal" id="customModal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon"></div>
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-text" id="modalText"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <!-- ‰∏áËÉΩÈ™∞Â≠ê -->
    <button class="cheat-btn" onclick="toggleCheatPanel()"></button>
    <div class="cheat-panel" id="cheatPanel">
        <div class="cheat-title">üé≤ ‰∏áËÉΩÈ™∞Â≠ê</div>
        <div class="cheat-dice-grid">
            <button class="cheat-dice-btn" onclick="cheatRoll(1)">1</button>
            <button class="cheat-dice-btn" onclick="cheatRoll(2)">2</button>
            <button class="cheat-dice-btn" onclick="cheatRoll(3)">3</button>
            <button class="cheat-dice-btn" onclick="cheatRoll(4)">4</button>
            <button class="cheat-dice-btn" onclick="cheatRoll(5)">5</button>
            <button class="cheat-dice-btn" onclick="cheatRoll(6)">6</button>
            <button class="cheat-dice-btn" onclick="cheatRoll(7)">7</button>
            <button class="cheat-dice-btn" onclick="cheatRoll(8)">8</button>
            <button class="cheat-dice-btn" onclick="cheatRoll(9)">9</button>
            <button class="cheat-dice-btn" onclick="cheatRoll(10)">10</button>
            <button class="cheat-dice-btn" onclick="cheatRoll(11)">11</button>
            <button class="cheat-dice-btn" onclick="cheatRoll(12)">12</button>
        </div>
        
        
		<div class="cheat-section">
            <div class="cheat-label">Ëá™ÈÄâÂú∞ÂùóÁßªÂä®</div>
            <button class="cheat-apply-btn" onclick="enableTeleportMode()">üìç ÈÄâÊã©Âú∞Âùó</button>
            
            <div class="cheat-label">ÊåáÂÆöÁé©ÂÆ∂Êìç‰Ωú</div>
            <select class="cheat-select" id="cheatPlayerSelect"></select>
            
            <button class="cheat-apply-btn" onclick="eliminatePlayer()">‚ùå Ê∑òÊ±∞Áé©ÂÆ∂</button>
            
            <div class="cheat-label">Ë∞ÉÊï¥ÈáëÂ∏Å</div>
            <input type="number" class="cheat-input" id="cheatMoneyInput" placeholder="ËæìÂÖ•ÈáëÈ¢ù(Ê≠£Ë¥ü)" />
            <button class="cheat-apply-btn" onclick="applyCheatMoney()">üí∞ Â∫îÁî®</button>
            
            <div class="cheat-label">ÈÄöË°åËØÅÊï∞Èáè</div>
            <input type="number" class="cheat-input" id="cheatPassInput" placeholder="Â¢ûÂä†Êï∞Èáè" />
            <button class="cheat-apply-btn" onclick="applyCheatPass()">üé´ Â¢ûÂä†ÈÄöË°åËØÅ</button>
            
            <button class="cheat-apply-btn" onclick="releaseFromJail()">üîì Á´ãÂç≥Âá∫Áã±</button>
        </div>
    </div>

    <script>
        // Ê∏∏ÊàèÈÖçÁΩÆ
        const COLORS = [
            '#4E6813','#B0A6DF','#74070E','#be3455',
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A',
            '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2',
            '#E74C3C', '#3498DB', '#2ECC71', '#F39C12',
            '#9B59B6', '#1ABC9C', '#E67E22', '#95A5A6'
        ];

        const COLOR_GROUPS = [
            { name: 'Ê£ïËâ≤', color: '#b74242', ids: [1, 2, 3] },
            { name: 'Á≤âËâ≤', color: '#7045ff', ids: [6, 7, 8] },
            { name: 'ÊµÖËìù', color: '#0460d9', ids: [11, 12, 13] },
            { name: 'Ê©ôËâ≤', color: '#FFA500', ids: [16, 17, 18] },
            { name: 'Á∫¢Ëâ≤', color: '#DC143C', ids: [21, 22, 23] },
            { name: 'ÈªÑËâ≤', color: '#FFD700', ids: [26, 27, 28] },
            { name: 'ÁªøËâ≤', color: '#32CD32', ids: [31, 32, 33] },
            { name: 'Ê∑±Ëìù', color: '#00008B', ids: [37, 38, 39] }
        ];

        const FACILITY_IDS = [5, 15, 25, 35];

        const CHANCE_EVENTS = [
            { type: 'money', amount: 1000, text: 'Èì∂Ë°åÂàÜÁ∫¢ÔºåËé∑Âæó Ôø•1000' },
            { type: 'money', amount: -800, text: 'Áº¥Á∫≥ÁΩöÊ¨æ Ôø•800' },
            { type: 'money', amount: 2000, text: '‰∏≠‰∫ÜÂΩ©Á•®ÔºåËé∑Âæó Ôø•2000' },
            { type: 'money', amount: 1500, text: 'ÊäïËµÑÊî∂ÁõäÔºåËé∑Âæó Ôø•1500' },
            { type: 'move', steps: 3, text: 'ÂâçËøõ 3 Ê≠•' },
            { type: 'move', steps: -2, text: 'ÂêéÈÄÄ 2 Ê≠•' },
            { type: 'jail', text: 'ËøõÂÖ•ÁõëÁã±ÔºÅ' },
            { type: 'pass', text: 'Ëé∑ÂæóÁõëÁã±ÈÄöË°åËØÅÔºÅ' },
            { type: 'repair', text: 'ÂØπ‰Ω†ÁöÑÁâ©‰∏öËøõË°åÂÖ®Èù¢Áª¥‰øÆ\nÊØè‰∏™Âú∞ÂùóÊîØ‰ªò Ôø•200' },
            { type: 'chairman', text: '‰Ωú‰∏∫Ëë£‰∫ãÂ±Ä‰∏ªÂ∏≠\nÂêëÂÖ∂‰ªñÊâÄÊúâÁé©ÂÆ∂ÊîØ‰ªò Ôø•500' },
            { type: 'birthday', text: '‰ªäÂ§©ÊòØ‰Ω†ÁöÑÁîüÊó•\nÂêëÂÖ∂‰ªñÊØè‰ΩçÁé©ÂÆ∂Êî∂Âèñ Ôø•100' },
            { type: 'nearestUtility', multiplier: 10, text: 'Áõ¥ËææÊúÄËøëÁöÑÂÖ¨ÂÖ±ËÆæÊñΩ\nËã•Êúâ‰∏ö‰∏ªÔºåÊîØ‰ªòÈ™∞Â≠êÁÇπÊï∞√ó10ÂÄçÁßüÈáë' },
            { type: 'chooseTeleport', text: 'ÈÄâÊã©‰∏Ä‰∏™Âú∞Âùó‰º†ÈÄÅ' }
        ];

        const DESTINY_EVENTS = [
            { type: 'money', amount: -500, text: 'ÊàøÂ±ãÁª¥‰øÆÔºåÊîØ‰ªò Ôø•500' },
            { type: 'money', amount: -1000, text: 'ÊÖàÂñÑÊçêÊ¨æÔºåÊîØ‰ªò Ôø•1000' },
            { type: 'money', amount: 2500, text: 'ÈÅó‰∫ßÁªßÊâøÔºåËé∑Âæó Ôø•2500' },
            { type: 'move', steps: 5, text: 'ÂâçËøõ 5 Ê≠•' },
            { type: 'teleport', target: 0, text: '‰º†ÈÄÅÂà∞Ëµ∑ÁÇπ' },
            { type: 'teleport', target: 20, text: '‰º†ÈÄÅÂà∞Âü∫Èáë‰ºö' },
            { type: 'nearestUtility', multiplier: 2, text: 'Áõ¥ËææÊúÄËøëÁöÑÂÖ¨ÂÖ±ËÆæÊñΩ\nËã•Êúâ‰∏ö‰∏ªÔºåÊîØ‰ªò‰∏§ÂÄçÁßüÈáë' },
            { type: 'pass', text: 'Ëé∑ÂæóÁõëÁã±ÈÄöË°åËØÅÔºÅ' }
        ];

        let players = [];
        let board = [];
        let nextId = 0;
        let currentIdx = 0;
        let gameStarted = false;
        let logs = [];
        let diceCount = 1;
        let tooltip = null;
        let teleportMode = false;
        let upgradeMode = false;
        let finalCircleShown = false;

        function init() {
            loadPlayerData();
            initBoard();
            renderPlayers();
            addLog('Ê¨¢ËøéÔºÅËØ∑Ê∑ªÂä†Áé©ÂÆ∂Âπ∂ÂºÄÂßãÊ∏∏Êàè');
            setupTooltips();
            updateCheatPlayerList();
        }

        function initBoard() {
            board = [
                { id: 0, type: 'start', name: 'Ëµ∑ÁÇπ', bonus: 2000 },
                { id: 1, type: 'property', name: 'Ë•øÂÆÅ', price: 100, level: 0, owner: null, rent: [50, 110, 220, 500], group: 0 },
                { id: 2, type: 'property', name: 'ÂÖ∞Â∑û', price: 120, level: 0, owner: null, rent: [60, 130, 260, 500], group: 0 },
                { id: 3, type: 'property', name: 'Èì∂Â∑ù', price: 140, level: 0, owner: null, rent: [70, 150, 300, 500], group: 0 },
                { id: 4, type: 'chance', name: 'Êú∫‰ºö' },
                { id: 5, type: 'facility', name: 'üöÇÁÅ´ËΩ¶', price: 200, owner: null, rent: 50 },
                { id: 6, type: 'property', name: 'ÊòÜÊòé', price: 150, level: 0, owner: null, rent: [80, 170, 340, 600], group: 1 },
                { id: 7, type: 'property', name: 'Ê≠¶Ê±â', price: 170, level: 0, owner: null, rent: [90, 190, 380, 600], group: 1 },
                { id: 8, type: 'property', name: 'ÂêàËÇ•', price: 190, level: 0, owner: null, rent: [100, 210, 420, 600], group: 1 },
                { id: 9, type: 'destiny', name: 'ÂëΩËøê' },
                { id: 10, type: 'jail', name: 'ËøõÁõëÁã±' },
                { id: 11, type: 'property', name: 'ÂìàÂ∞îÊª®', price: 200, level: 0, owner: null, rent: [100, 210, 420, 800], group: 2 },
                { id: 12, type: 'property', name: 'ÈïøÊò•', price: 220, level: 0, owner: null, rent: [110, 230, 460, 800], group: 2 },
                { id: 13, type: 'property', name: 'Ê≤àÈò≥', price: 240, level: 0, owner: null, rent: [120, 250, 500, 800], group: 2 },
                { id: 14, type: 'chance', name: 'Êú∫‰ºö' },
                { id: 15, type: 'facility', name: '‚úàÔ∏èÈ£ûÊú∫', price: 200, owner: null, rent: 50 },
                { id: 16, type: 'property', name: 'ÂçóÂÆÅ', price: 250, level: 0, owner: null, rent: [130, 270, 540, 900], group: 3 },
                { id: 17, type: 'property', name: 'Ë¥µÈò≥', price: 270, level: 0, owner: null, rent: [140, 290, 580, 900], group: 3 },
                { id: 18, type: 'property', name: 'ÊàêÈÉΩ', price: 290, level: 0, owner: null, rent: [150, 310, 620, 900], group: 3 },
                { id: 19, type: 'destiny', name: 'ÂëΩËøê' },
                { id: 20, type: 'foundation', name: 'Âü∫Èáë‰ºö' },
                { id: 21, type: 'property', name: 'Ë•øÂÆâ', price: 300, level: 0, owner: null, rent: [150, 310, 620, 1100], group: 4 },
                { id: 22, type: 'property', name: 'ÈÉëÂ∑û', price: 320, level: 0, owner: null, rent: [160, 330, 660, 1100], group: 4 },
                { id: 23, type: 'property', name: 'ÊµéÂçó', price: 340, level: 0, owner: null, rent: [170, 350, 680, 1100], group: 4 },
                { id: 24, type: 'chance', name: 'Êú∫‰ºö' },
                { id: 25, type: 'facility', name: 'üö¢ËΩÆËàπ', price: 200, owner: null, rent: 50 },
                { id: 26, type: 'property', name: 'Áü≥ÂÆ∂Â∫Ñ', price: 350, level: 0, owner: null, rent: [170, 370, 640, 1200], group: 5 },
                { id: 27, type: 'property', name: 'Â§©Ê¥•', price: 370, level: 0, owner: null, rent: [180, 390, 680, 1200], group: 5 },
                { id: 28, type: 'property', name: 'Âåó‰∫¨', price: 390, level: 0, owner: null, rent: [190, 410, 720, 1200], group: 5 },
                { id: 29, type: 'destiny', name: 'ÂëΩËøê' },
                { id: 30, type: 'prison', name: 'ÁõëÁã±' },
                { id: 31, type: 'property', name: 'ÂπøÂ∑û', price: 400, level: 0, owner: null, rent: [200, 410, 720, 1400], group: 6 },
                { id: 32, type: 'property', name: 'Á¶èÂ∑û', price: 420, level: 0, owner: null, rent: [210, 430, 760, 1400], group: 6 },
                { id: 33, type: 'property', name: 'ÈïøÊ≤ô', price: 440, level: 0, owner: null, rent: [220, 450, 780, 1400], group: 6 },
                { id: 34, type: 'chance', name: 'Êú∫‰ºö' },
                { id: 35, type: 'facility', name: 'ÂèëÁîµÂéÇ', price: 200, owner: null, rent: 50 },
                { id: 36, type: 'destiny', name: 'ÂëΩËøê' },
                { id: 37, type: 'property', name: 'Êù≠Â∑û', price: 450, level: 0, owner: null, rent: [230, 460, 740, 1500], group: 7 },
                { id: 38, type: 'property', name: 'Âçó‰∫¨', price: 470, level: 0, owner: null, rent: [240, 490, 780, 1500], group: 7 },
                { id: 39, type: 'property', name: '‰∏äÊµ∑', price: 490, level: 0, owner: null, rent: [250, 510, 820, 1500], group: 7 }
            ];
        }

        function savePlayerData() {
            const data = players.map(p => ({ id: p.id, name: p.name, color: p.color }));
            localStorage.setItem('monopoly_players', JSON.stringify(data));
        }

        function loadPlayerData() {
            const saved = localStorage.getItem('monopoly_players');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    players = data.map(p => ({
                        ...p,
                        position: 0,
                        money: 10000,
                        properties: [],
                        active: true,
                        inJail: false,
                        jailTurns: 0,
                        jailPass: 0
                    }));
                    nextId = Math.max(...players.map(p => p.id)) + 1;
                } catch (e) {
                    initDefaultPlayers();
                }
            } else {
                initDefaultPlayers();
            }
        }

        function initDefaultPlayers() {
            players = [
                { id: 0, name: 'Áé©ÂÆ∂1', color: COLORS[0], position: 0, money: 5000, properties: [], active: true, inJail: false, jailTurns: 0, jailPass: 0 },
                { id: 1, name: 'Áé©ÂÆ∂2', color: COLORS[1], position: 0, money: 5000, properties: [], active: true, inJail: false, jailTurns: 0, jailPass: 0 }
            ];
            nextId = 2;
        }

        function addPlayer() {
            if (players.length >= 8) {
                showAlert('ÊúÄÂ§ö8ÂêçÁé©ÂÆ∂ÔºÅ');
                return;
            }
            players.push({
                id: nextId++,
                name: `Áé©ÂÆ∂${players.length + 1}`,
                color: COLORS[players.length % COLORS.length],
                position: 0,
                money: 10000,
                properties: [],
                active: true,
                inJail: false,
                jailTurns: 0,
                jailPass: 0
            });
            renderPlayers();
            updateCheatPlayerList();
        }

        function removePlayer(id) {
            if (players.length <= 2) {
                showAlert('Ëá≥Â∞ëÈúÄË¶Å2ÂêçÁé©ÂÆ∂ÔºÅ');
                return;
            }
            players = players.filter(p => p.id !== id);
            renderPlayers();
            savePlayerData();
            updateCheatPlayerList();
        }

        function editName(id) {
            const p = players.find(p => p.id === id);
            showPrompt('ËæìÂÖ•Êñ∞ÂêçÁß∞:', p.name, (newName) => {
                if (newName && newName.trim()) {
                    p.name = newName.trim();
                    renderPlayers();
                    if (gameStarted) updateCurrent();
                    savePlayerData();
                }
            });
        }

        function showColorPicker(id) {
            const p = players.find(p => p.id === id);
            const grid = document.getElementById('colorGrid');
            grid.innerHTML = '';
            COLORS.forEach(c => {
                const div = document.createElement('div');
                div.className = 'color-option' + (c === p.color ? ' selected' : '');
                div.style.backgroundColor = c;
                div.onclick = () => selectColor(id, c);
                grid.appendChild(div);
            });
            document.getElementById('colorPickerModal').classList.add('show');
        }

        function selectColor(id, color) {
            const p = players.find(p => p.id === id);
            p.color = color;
            if (gameStarted) {
                const piece = document.getElementById(`piece-${id}`);
                if (piece) piece.style.backgroundColor = color;
                board.forEach((s, i) => {
                    if (s.owner === players.findIndex(p => p.id === id)) {
                        const el = document.querySelector(`[data-id="${i}"]`);
                        if (el && s.type === 'property') {
                            el.style.backgroundColor = color + '40';
                        }
                    }
                });
                updateFullSetEffects();
            }
            document.getElementById('colorPickerModal').classList.remove('show');
            renderPlayers();
            savePlayerData();
        }

        function selectDiceCount(count) {
            diceCount = count;
            document.querySelectorAll('.dice-count-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === count - 1);
            });
        }

        function startGame() {
            if (players.length < 2) {
                showAlert('Ëá≥Â∞ëÈúÄË¶Å2ÂêçÁé©ÂÆ∂ÔºÅ');
                return;
            }
            gameStarted = true;
            document.getElementById('playersPanel').classList.add('game-started');
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('currentPlayerBox').style.display = 'block';
            document.getElementById('diceControl').style.display = 'flex';
            addLog('üéÆ Ê∏∏ÊàèÂºÄÂßãÔºÅ');
            renderBoard();
            updateCurrent();
            updateCheatPlayerList();
        }

        function resetGame() {
            showConfirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊ∏∏ÊàèÂêóÔºü', () => {
                location.reload();
            });
        }

        function renderBoard() {
            const boardEl = document.getElementById('gameBoard');
            const centerEl = boardEl.querySelector('.board-center');
            boardEl.innerHTML = '';
            boardEl.appendChild(centerEl);
            
            
            const positions = [
                ...Array.from({length: 11}, (_, i) => ({r: 11, c: 11 - i})),
                ...Array.from({length: 10}, (_, i) => ({r: 10 - i, c: 1})),
                ...Array.from({length: 10}, (_, i) => ({r: 1, c: 2 + i})),
                ...Array.from({length: 9}, (_, i) => ({r: 2 + i, c: 11}))
            ];

            board.forEach((space, idx) => {
                const div = document.createElement('div');
                div.className = `space ${space.type}`;
                if ([0, 10, 20, 30].includes(idx)) div.classList.add('corner');
                div.dataset.id = idx;
                
                const pos = positions[idx];
                div.style.gridRow = pos.r;
                div.style.gridColumn = pos.c;
                
                let html = '';
                
                if (space.type === 'property') {
                    const group = COLOR_GROUPS.find(g => g.ids.includes(idx));
                    if (group) {
                        html += `<div class="color-bar" style="background: ${group.color};"></div>`;
                    }
                    
                    if (space.owner !== null) {
                        const ownerColor = players[space.owner].color;
                        div.style.backgroundColor = ownerColor + '40';
                        div.style.borderColor = ownerColor;
                        div.style.borderWidth = '3px';
                    }
                }
                
                html += `<div class="space-name">${space.name}</div>`;
                
                if (space.price) {
                    html += `<div class="space-price">Ôø•${space.price}</div>`;
                }
                
                if (space.type === 'property' && space.level > 0) {
                    html += `<div class="level-badge">Lv.${space.level}</div>`;
                }
                
                div.innerHTML = html;
                
                if (teleportMode || upgradeMode) {
                    if (space.type === 'property') {
                        if (teleportMode || (upgradeMode && space.owner === currentIdx && space.level < 3)) {
                            div.classList.add('clickable');
                            div.onclick = () => {
                                if (teleportMode) teleportToSpace(idx);
                                if (upgradeMode) upgradeFromFoundation(idx);
                            };
                        }
                    }
                }
                
                boardEl.appendChild(div);
            });

            players.forEach(p => {
                const piece = document.createElement('div');
                piece.className = 'player-piece';
                piece.id = `piece-${p.id}`;
                piece.style.backgroundColor = p.color;
                piece.textContent = players.findIndex(pl => pl.id === p.id) + 1;
                if (p.inJail) piece.classList.add('in-jail');
                boardEl.appendChild(piece);
                updatePiecePos(p.id, p.position);
            });

            updateFullSetEffects();
        }

        function updateFullSetEffects() {
            COLOR_GROUPS.forEach(group => {
                const allOwned = group.ids.every(id => {
                    const space = board[id];
                    return space.owner !== null && space.owner !== undefined;
                });
                
                if (allOwned) {
                    const owner = board[group.ids[0]].owner;
                    const sameOwner = group.ids.every(id => board[id].owner === owner);
                    
                    if (sameOwner) {
                        group.ids.forEach(id => {
                            const el = document.querySelector(`[data-id="${id}"]`);
                            if (el) {
                                el.classList.add('full-set');
                                el.style.setProperty('color', group.color);
                            }
                        });
                    }
                }
            });
        }

        function setupTooltips() {
            document.addEventListener('mousemove', (e) => {
                const space = e.target.closest('.space');
                if (space && gameStarted) {
                    const idx = parseInt(space.dataset.id);
                    const data = board[idx];
                    
                    if (data.type === 'property') {
                        if (!tooltip) {
                            tooltip = document.createElement('div');
                            tooltip.className = 'tooltip';
                            document.body.appendChild(tooltip);
                        }
                        
                        const upgradePrice = Math.floor(data.price * 0.4);
                        
                        let html = `<div class="tooltip-row"><strong>${data.name}</strong></div>`;
                        html += `<div class="tooltip-row">üí∞ Ë¥≠‰π∞: Ôø•${data.price}</div>`;
                        html += `<div class="tooltip-row">‚¨ÜÔ∏è ÂçáÁ∫ß: Ôø•${upgradePrice}</div>`;
                        html += `<div class="tooltip-row">ÁßüÈáë Lv.0-3:</div>`;
                        data.rent.forEach((r, i) => {
                            html += `<div class="tooltip-row">  Lv.${i}: Ôø•${r}</div>`;
                        });
                        
                        if (hasFullSet(data.owner, data.group)) {
                            html += `<div class="tooltip-row" style="color: #f59e0b;">‚≠ê ÈõÜÈΩêÁøªÂÄç!</div>`;
                        }
                        
                        tooltip.innerHTML = html;
                        tooltip.style.left = (e.pageX + 15) + 'px';
                        tooltip.style.top = (e.pageY + 15) + 'px';
                        tooltip.style.display = 'block';
                    } else if (data.type === 'facility') {
                        if (!tooltip) {
                            tooltip = document.createElement('div');
                            tooltip.className = 'tooltip';
                            document.body.appendChild(tooltip);
                        }
                        
                        let html = `<div class="tooltip-row"><strong>${data.name}</strong></div>`;
                        html += `<div class="tooltip-row">üí∞ Ë¥≠‰π∞: Ôø•${data.price}</div>`;
                        html += `<div class="tooltip-row">ÁßüÈáë: Ôø•${data.rent}</div>`;
                        
                        if (hasFacilitySet(data.owner)) {
                            html += `<div class="tooltip-row" style="color: #f59e0b;">‚≠ê ÈõÜÈΩêÁøªÂÄç!</div>`;
                        }
                        
                        tooltip.innerHTML = html;
                        tooltip.style.left = (e.pageX + 15) + 'px';
                        tooltip.style.top = (e.pageY + 15) + 'px';
                        tooltip.style.display = 'block';
                    } else {
                        hideTooltip();
                    }
                } else {
                    hideTooltip();
                }
            });
        }

        function hideTooltip() {
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        function updatePiecePos(id, pos) {
            const piece = document.getElementById(`piece-${id}`);
            if (!piece) return;
            
            const spaceEl = document.querySelector(`[data-id="${pos}"]`);
            if (!spaceEl) return;
            
            const rect = spaceEl.getBoundingClientRect();
            const boardRect = document.getElementById('gameBoard').getBoundingClientRect();
            
            const playersHere = players.filter(p => p.position === pos && p.active);
            const myIndex = playersHere.findIndex(p => p.id === id);
            
            const offsetX = (myIndex % 3) * 26 - 26;
            const offsetY = Math.floor(myIndex / 3) * 26 - 13;
            
            piece.style.left = (rect.left - boardRect.left + rect.width / 2 + offsetX) + 'px';
            piece.style.top = (rect.top - boardRect.top + rect.height / 2 + offsetY) + 'px';
        }

        function updateCurrent() {
            const p = players[currentIdx];
            const badge = document.getElementById('currentPlayerBadge');
            let status = '';
            if (p.inJail) status = ' üîíÁõëÁã±';
            if (p.jailPass > 0) status += ` üé´√ó${p.jailPass}`;
            badge.innerHTML = `<strong style="font-size: 16px;">${p.name}${status}</strong><span style="color: #666;">üí∞ Ôø•${p.money}</span>`;
            badge.style.backgroundColor = p.color + '20';
            badge.style.borderColor = p.color;

            document.querySelectorAll('.player-piece').forEach(el => {
                el.classList.remove('active');
            });
            const piece = document.getElementById(`piece-${p.id}`);
            if (piece) piece.classList.add('active');
        }

        function renderPlayers() {
            const list = document.getElementById('playersList');
            list.innerHTML = '';

            let sortedPlayers = [...players];
            if (gameStarted) {
                sortedPlayers.sort((a, b) => b.money - a.money);
            }

            sortedPlayers.forEach((p) => {
                const i = players.findIndex(pl => pl.id === p.id);
                const div = document.createElement('div');
                div.className = `player-card ${gameStarted && currentIdx === i ? 'active' : ''} ${!p.active ? 'bankrupt' : ''}`;
                div.style.backgroundColor = p.color + '15';
                div.style.borderColor = p.color;
                if (gameStarted && currentIdx === i) {
                    div.style.boxShadow = `0 0 0 3px ${p.color}40`;
                }

                let propsHtml = '';
                if (p.properties.length > 0) {
                    propsHtml = '<div class="properties-grid">';
                    p.properties.forEach(propId => {
                        const prop = board[propId];
                        if (prop.type === 'property') {
                            propsHtml += `<div class="property-chip">${prop.name}${prop.level > 0 ? ' Lv.' + prop.level : ''}</div>`;
                        } else {
                            propsHtml += `<div class="property-chip">${prop.name}</div>`;
                        }
                    });
                    propsHtml += '</div>';
                }

                let statusTag = '';
                if (!p.active) {
                    statusTag = '<div class="status-tag bankrupt-tag">Á†¥‰∫ß</div>';
                } else if (p.inJail) {
                    statusTag = `<div class="status-tag jail-tag">ÁõëÁã± ${p.jailTurns}/3</div>`;
                } else if (p.jailPass > 0) {
                    statusTag = `<div class="status-tag pass-tag">üé´√ó${p.jailPass}</div>`;
                }

                div.innerHTML = `
                    <div class="player-header">
                        <div class="player-left">
                            <div class="avatar" style="background-color: ${p.color};" onclick="showColorPicker(${p.id})">${players.findIndex(pl => pl.id === p.id) + 1}</div>
                            <div class="player-name" onclick="editName(${p.id})">${p.name}</div>
                        </div>
                        <div class="player-right">
                            ${statusTag}
                            ${!gameStarted ? `<button class="btn-delete" onclick="removePlayer(${p.id})">Âà†Èô§</button>` : ''}
                        </div>
                    </div>
                    ${gameStarted ? `
                    <div class="player-stats">
                        <div class="stat-item">üí∞ <strong>Ôø•${p.money}</strong></div>
                        <div class="stat-item">üè† ${p.properties.length} Â§ÑÂú∞‰∫ß</div>
                    </div>
                    ${propsHtml}
                    ` : ''}
                `;

                list.appendChild(div);
            });
        }

        function addLog(msg) {
            logs.push(msg);
            if (logs.length > 30) logs.shift();
            const el = document.getElementById('logContent');
            if (el) {
                el.innerHTML = logs.slice(-20).map(l => `<div class="log-item-mini">${l}</div>`).join('');
                el.scrollTop = el.scrollHeight;
            }
        }

        function showDiceAnimation(values, callback) {
            const boardCenter = document.querySelector('.board-center');
            const diceEls = [];
            
            values.forEach((val, idx) => {
                const diceEl = document.createElement('div');
                diceEl.className = 'dice-animation';
                diceEl.textContent = 'üé≤';
                diceEl.style.left = `calc(50% - ${40 + idx * 90}px)`;
                diceEl.style.top = 'calc(50% - 40px)';
                boardCenter.appendChild(diceEl);
                diceEls.push(diceEl);
            });
            
            setTimeout(() => {
                diceEls.forEach((el, idx) => {
                    el.textContent = values[idx];
                });
            }, 500);
            
            setTimeout(() => {
                diceEls.forEach(el => el.remove());
                if (callback) callback();
            }, 1500);
        }

        function rollDice() {
            if (!gameStarted) {
                showAlert('ËØ∑ÂÖàÂºÄÂßãÊ∏∏ÊàèÔºÅ');
                return;
            }

            const p = players[currentIdx];
            if (!p.active) {
                nextPlayer();
                return;
            }

            if (p.inJail) {
                if (p.jailPass > 0) {
                    showConfirm('‰ΩøÁî®ÁõëÁã±ÈÄöË°åËØÅÂá∫Áã±Ôºü', () => {
                        p.jailPass--;
                        p.inJail = false;
                        p.jailTurns = 0;
                        const piece = document.getElementById(`piece-${p.id}`);
                        if (piece) piece.classList.remove('in-jail');
                        addLog(`üé´ ${p.name} ‰ΩøÁî®ÈÄöË°åËØÅÂá∫Áã±`);
                        showEventModal('üé´', 'Âá∫Áã±ÊàêÂäü', `${p.name} ‰ΩøÁî®ÈÄöË°åËØÅÂá∫Áã±ÔºÅ`, () => {
                            renderPlayers();
                            updateCurrent();
                        });
                    }, () => {
                        rollInJail(p);
                    });
                } else {
                    rollInJail(p);
                }
                return;
            }

            document.getElementById('diceBtn').disabled = true;
            const dices = [];
            for (let i = 0; i < diceCount; i++) {
                dices.push(Math.floor(Math.random() * 6) + 1);
            }
            const total = dices.reduce((a, b) => a + b, 0);
            
            addLog(`üé≤ ${p.name} Êé∑Âá∫‰∫Ü ${dices.join('+')}=${total} ÁÇπ`);
            
            showDiceAnimation(dices, () => {
                const newPos = (p.position + total) % board.length;
                movePlayer(currentIdx, newPos);
            });
        }

        function rollInJail(p) {
            const dice = Math.floor(Math.random() * 6) + 1;
            showDiceAnimation([dice], () => {
                if (dice === 6) {
                    p.inJail = false;
                    p.jailTurns = 0;
                    const piece = document.getElementById(`piece-${p.id}`);
                    if (piece) piece.classList.remove('in-jail');
                    addLog(`üéâ ${p.name} ÊäïÂá∫6ÁÇπÔºåÂá∫Áã±‰∫ÜÔºÅ`);
                    showEventModal('üéâ', 'Âá∫Áã±ÊàêÂäü', `${p.name} ÊäïÂá∫6ÁÇπÔºåÊàêÂäüÂá∫Áã±ÔºÅ\nËØ∑ÂÜçÊäï‰∏ÄÊ¨°È™∞Â≠ê`, () => {
                        renderPlayers();
                        updateCurrent();
                        document.getElementById('diceBtn').disabled = false;
                    });
                } else {
                    p.jailTurns++;
                    addLog(`üîí ${p.name} ÊäïÂá∫${dice}ÁÇπÔºåÁªßÁª≠ÂÖ≥Êäº (${p.jailTurns}/3)`);
                    if (p.jailTurns >= 3) {
                        p.inJail = false;
                        p.jailTurns = 0;
                        const piece = document.getElementById(`piece-${p.id}`);
                        if (piece) piece.classList.remove('in-jail');
                        addLog(`‚è∞ ${p.name} ÂàëÊª°ÈáäÊîæÔºÅ`);
                    }
                    showEventModal('üîí', 'Âá∫Áã±Â§±Ë¥•', `ÊäïÂá∫${dice}ÁÇπÔºåÈúÄË¶Å6ÁÇπÊâçËÉΩÂá∫Áã±\nÂ∑≤ÂÖ≥Êäº ${p.jailTurns}/3 ÂõûÂêà${p.jailTurns >= 3 ? '\nÂàëÊª°ÈáäÊîæÔºÅ' : ''}`, () => {
                        renderPlayers();
                        updateCurrent();
                        nextPlayer();
                    });
                }
            });
        }

        function toggleCheatPanel() {
            const panel = document.getElementById('cheatPanel');
            panel.classList.toggle('show');
        }

        function updateCheatPlayerList() {
            const select = document.getElementById('cheatPlayerSelect');
            if (!select) return;
            select.innerHTML = '<option value="">ÈÄâÊã©Áé©ÂÆ∂</option>';
            players.forEach((p, i) => {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = p.name;
                select.appendChild(option);
            });
        }

        function cheatRoll(value) {
            if (!gameStarted) return;
            const p = players[currentIdx];
            if (!p.active) return;

            if (p.inJail) {
                showDiceAnimation([value], () => {
                    if (value === 6) {
                        p.inJail = false;
                        p.jailTurns = 0;
                        const piece = document.getElementById(`piece-${p.id}`);
                        if (piece) piece.classList.remove('in-jail');
                        addLog(`üéâ ${p.name} ÊäïÂá∫6ÁÇπÔºåÂá∫Áã±‰∫ÜÔºÅ`);
                        showEventModal('üéâ', 'Âá∫Áã±ÊàêÂäü', `${p.name} ÊäïÂá∫6ÁÇπÔºåÊàêÂäüÂá∫Áã±ÔºÅ`, () => {
                            renderPlayers();
                            updateCurrent();
                            document.getElementById('diceBtn').disabled = false;
                        });
                    } else {
                        p.jailTurns++;
                        addLog(`üîí ${p.name} ÊäïÂá∫${value}ÁÇπÔºåÁªßÁª≠ÂÖ≥Êäº (${p.jailTurns}/3)`);
                        if (p.jailTurns >= 3) {
                            p.inJail = false;
                            p.jailTurns = 0;
                            const piece = document.getElementById(`piece-${p.id}`);
                            if (piece) piece.classList.remove('in-jail');
                            addLog(`‚è∞ ${p.name} ÂàëÊª°ÈáäÊîæÔºÅ`);
                        }
                        showEventModal('üîí', 'Âá∫Áã±Â§±Ë¥•', `ÊäïÂá∫${value}ÁÇπ\nÂ∑≤ÂÖ≥Êäº ${p.jailTurns}/3 ÂõûÂêà`, () => {
                            renderPlayers();
                            updateCurrent();
                            nextPlayer();
                        });
                    }
                });
                document.getElementById('cheatPanel').classList.remove('show');
                return;
            }

            document.getElementById('diceBtn').disabled = true;
            addLog(`üé≤ ${p.name} Êé∑Âá∫‰∫Ü ${value} ÁÇπ`);
            
            showDiceAnimation([value], () => {
                const newPos = (p.position + value) % board.length;
                movePlayer(currentIdx, newPos);
            });
            
            document.getElementById('cheatPanel').classList.remove('show');
        }

        function enableTeleportMode() {
            teleportMode = true;
            document.getElementById('cheatPanel').classList.remove('show');
            showEventModal('üìç', 'ÈÄâÊã©Âú∞Âùó', 'ËØ∑ÁÇπÂáªÂú∞Âõæ‰∏äÁöÑ‰ªªÊÑèÂú∞‰∫ß‰º†ÈÄÅ', () => {
                renderBoard();
            });
        }

        function eliminatePlayer() {
            const selectEl = document.getElementById('cheatPlayerSelect');
            const playerIdx = parseInt(selectEl.value);
            
            if (isNaN(playerIdx) || playerIdx < 0 || playerIdx >= players.length) {
                showAlert('ËØ∑ÈÄâÊã©Áé©ÂÆ∂');
                return;
            }
            
            showConfirm(`Á°ÆÂÆöÊ∑òÊ±∞ ${players[playerIdx].name}Ôºü`, () => {
                handleBankruptcy(playerIdx);
                document.getElementById('cheatPanel').classList.remove('show');
            });
        }

        function applyCheatMoney() {
            const selectEl = document.getElementById('cheatPlayerSelect');
            const inputEl = document.getElementById('cheatMoneyInput');
            
            const playerIdx = parseInt(selectEl.value);
            const amount = parseInt(inputEl.value);
            
            if (isNaN(playerIdx) || playerIdx < 0 || playerIdx >= players.length) {
                showAlert('ËØ∑ÈÄâÊã©Áé©ÂÆ∂');
                return;
            }
            
            if (isNaN(amount)) {
                showAlert('ËØ∑ËæìÂÖ•ÈáëÈ¢ù');
                return;
            }
            
            players[playerIdx].money += amount;
            addLog(`üí∞ ${players[playerIdx].name} ${amount > 0 ? 'Ëé∑Âæó' : 'Â§±Âéª'} Ôø•${Math.abs(amount)}`);
            renderPlayers();
            if (currentIdx === playerIdx) updateCurrent();
            
            inputEl.value = '';
            document.getElementById('cheatPanel').classList.remove('show');
        }

        function applyCheatPass() {
            const selectEl = document.getElementById('cheatPlayerSelect');
            const inputEl = document.getElementById('cheatPassInput');
            
            const playerIdx = parseInt(selectEl.value);
            const amount = parseInt(inputEl.value);
            
            if (isNaN(playerIdx) || playerIdx < 0 || playerIdx >= players.length) {
                showAlert('ËØ∑ÈÄâÊã©Áé©ÂÆ∂');
                return;
            }
            
            if (isNaN(amount) || amount < 1) {
                showAlert('ËØ∑ËæìÂÖ•Êï∞Èáè');
                return;
            }
            
            players[playerIdx].jailPass += amount;
            addLog(`üé´ ${players[playerIdx].name} Ëé∑Âæó ${amount} Âº†ÈÄöË°åËØÅ`);
            renderPlayers();
            if (currentIdx === playerIdx) updateCurrent();
            
            inputEl.value = '';
            document.getElementById('cheatPanel').classList.remove('show');
        }

        function releaseFromJail() {
            const selectEl = document.getElementById('cheatPlayerSelect');
            const playerIdx = parseInt(selectEl.value);
            
            if (isNaN(playerIdx) || playerIdx < 0 || playerIdx >= players.length) {
                showAlert('ËØ∑ÈÄâÊã©Áé©ÂÆ∂');
                return;
            }
            
            const p = players[playerIdx];
            if (!p.inJail) {
                showAlert('ËØ•Áé©ÂÆ∂‰∏çÂú®ÁõëÁã±');
                return;
            }
            
            p.inJail = false;
            p.jailTurns = 0;
            const piece = document.getElementById(`piece-${p.id}`);
            if (piece) piece.classList.remove('in-jail');
            addLog(`üîì ${p.name} Ë¢´ÈáäÊîæÂá∫Áã±`);
            renderPlayers();
            if (currentIdx === playerIdx) updateCurrent();
            
            document.getElementById('cheatPanel').classList.remove('show');
        }

        function movePlayer(idx, newPos) {
            const p = players[idx];
            const oldPos = p.position;
            p.position = newPos;
            
            if (newPos === 0 || (newPos < oldPos && newPos !== 0)) {
                p.money += board[0].bonus;
                addLog(`‚ú® ${p.name} ${newPos === 0 ? 'Âà∞Ëææ' : 'ÁªèËøá'}Ëµ∑ÁÇπÔºåËé∑Âæó Ôø•${board[0].bonus}`);
            }
            
            updatePiecePos(p.id, newPos);
            
            setTimeout(() => {
                handleLanding(idx, newPos);
            }, 600);
        }

        function handleLanding(idx, pos) {
            const space = board[pos];
            const p = players[idx];
            
            addLog(`üìç ${p.name} Âà∞Ëææ ${space.name}`);
            
            switch (space.type) {
                case 'property':
                    handleProperty(idx, pos);
                    break;
                case 'facility':
                    handleFacility(idx, pos);
                    break;
                case 'chance':
                    triggerEvent(idx, 'chance');
                    break;
                case 'destiny':
                    triggerEvent(idx, 'destiny');
                    break;
                case 'foundation':
                    handleFoundation(idx);
                    break;
                case 'jail':
                    sendToJail(idx);
                    break;
                case 'prison':
                    addLog(`üòå ${p.name} Âè™ÊòØË∑ØËøáÁõëÁã±`);
                    showEventModal('üòå', 'Ë∑ØËøáÁõëÁã±', `${p.name} Âè™ÊòØË∑ØËøáÁõëÁã±`, () => {
                        nextPlayer();
                    });
                    break;
                default:
                    nextPlayer();
            }
        }

        function handleFoundation(idx) {
            const p = players[idx];
            const myProperties = p.properties.filter(propId => {
                const prop = board[propId];
                return prop.type === 'property' && prop.level < 3;
            });

            if (myProperties.length > 0) {
                showModal('üè¶', 'Âü∫Èáë‰ºö', 'ÈÄâÊã©‰∏ÄÈ°πÊúçÂä°', [
                    { type: 'modal-btn-confirm', text: 'ÂçáÁ∫ßÂú∞‰∫ß', callback: () => {
                        upgradeMode = true;
                        showEventModal('‚¨ÜÔ∏è', 'ÈÄâÊã©Âú∞‰∫ß', 'ÁÇπÂáª‰Ω†Ë¶ÅÂçáÁ∫ßÁöÑÂú∞‰∫ß', () => {
                            renderBoard();
                        });
                    }},
                    { type: 'modal-btn-confirm', text: 'Ë¥≠‰π∞ÈÄöË°åËØÅ (Ôø•500)', callback: () => {
                        if (p.money >= 500) {
                            p.money -= 500;
                            p.jailPass++;
                            addLog(`üé´ ${p.name} Ë¥≠‰π∞‰∫ÜÁõëÁã±ÈÄöË°åËØÅ`);
                            renderPlayers();
                            updateCurrent();
                            nextPlayer();
                        } else {
                            showAlert('ËµÑÈáë‰∏çË∂≥');
                        }
                    }},
                    { type: 'modal-btn-cancel', text: 'ÂèñÊ∂à', callback: () => {
                        nextPlayer();
                    }}
                ]);
            } else {
                showModal('üè¶', 'Âü∫Èáë‰ºö', '‰Ω†Ê≤°ÊúâÂèØÂçáÁ∫ßÁöÑÂú∞‰∫ß', [
                    { type: 'modal-btn-confirm', text: 'Ë¥≠‰π∞ÈÄöË°åËØÅ (Ôø•500)', callback: () => {
                        if (p.money >= 500) {
                            p.money -= 500;
                            p.jailPass++;
                            addLog(`üé´ ${p.name} Ë¥≠‰π∞‰∫ÜÁõëÁã±ÈÄöË°åËØÅ`);
                            renderPlayers();
                            updateCurrent();
                            nextPlayer();
                        } else {
                            showAlert('ËµÑÈáë‰∏çË∂≥');
                        }
                    }},
                    { type: 'modal-btn-cancel', text: 'ÂèñÊ∂à', callback: () => {
                        nextPlayer();
                    }}
                ]);
            }
        }

        function upgradeFromFoundation(propId) {
            upgradeMode = false;
            const prop = board[propId];
            const p = players[currentIdx];
            const upgradePrice = Math.floor(prop.price * 0.4);
            
            if (p.money >= upgradePrice) {
                p.money -= upgradePrice;
                prop.level++;
                addLog(`‚¨ÜÔ∏è ${p.name} ÂçáÁ∫ß‰∫Ü ${prop.name} Âà∞ Lv.${prop.level}`);
                renderPlayers();
                updateCurrent();
                renderBoard();
                nextPlayer();
            } else {
                showAlert('ËµÑÈáë‰∏çË∂≥');
                renderBoard();
            }
        }

        function sendToJail(idx) {
            const p = players[idx];
            
            if (p.jailPass > 0) {
                showConfirm('‰ΩøÁî®ÁõëÁã±ÈÄöË°åËØÅÈÅøÂÖçÂÖ•Áã±Ôºü', () => {
                    p.jailPass--;
                    addLog(`üé´ ${p.name} ‰ΩøÁî®ÈÄöË°åËØÅÈÅøÂÖçÂÖ•Áã±`);
                    showEventModal('üé´', 'ÈÄöË°åËØÅ', `${p.name} ‰ΩøÁî®ÈÄöË°åËØÅÈÅøÂÖçÂÖ•Áã±ÔºÅ`, () => {
                        renderPlayers();
                        updateCurrent();
                        nextPlayer();
                    });
                }, () => {
                    goToJail(idx);
                });
            } else {
                goToJail(idx);
            }
        }

        function goToJail(idx) {
            const p = players[idx];
            p.inJail = true;
            p.jailTurns = 0;
            p.position = 30;
            updatePiecePos(p.id, 30);
            const piece = document.getElementById(`piece-${p.id}`);
            if (piece) piece.classList.add('in-jail');
            addLog(`üöî ${p.name} ËøõÂÖ•ÁõëÁã±`);
            showEventModal('üöî', 'ËøõÂÖ•ÁõëÁã±', '‰Ω†Ë¢´ÂÖ≥ËøõÁõëÁã±‰∫ÜÔºÅ\nÈúÄË¶ÅÊäïÂá∫6ÁÇπÊâçËÉΩÂá∫Áã±', () => {
                renderPlayers();
                updateCurrent();
                nextPlayer();
            });
        }

        function handleProperty(idx, pos) {
            const prop = board[pos];
            const p = players[idx];
            
            if (prop.owner === null) {
                if (p.money >= prop.price) {
                    showConfirm(`Ë¥≠‰π∞ ${prop.name}\n‰ª∑Ê†º: Ôø•${prop.price}`, () => {
                        buyProperty(idx, pos);
                    }, () => {
                        nextPlayer();
                    });
                } else {
                    addLog(`‚ùå ${p.name} ËµÑÈáë‰∏çË∂≥`);
                    showEventModal('‚ùå', 'ËµÑÈáë‰∏çË∂≥', `Êó†Ê≥ïË¥≠‰π∞ ${prop.name}\nÈúÄË¶Å Ôø•${prop.price}`, () => {
                        nextPlayer();
                    });
                }
            } else if (prop.owner === idx) {
                const upgradePrice = Math.floor(prop.price * 0.4);
                if (prop.level < 3 && p.money >= upgradePrice) {
                    showConfirm(`ÂçáÁ∫ß ${prop.name}\nÂçáËá≥ Lv.${prop.level + 1}\n‰ª∑Ê†º: Ôø•${upgradePrice}`, () => {
                        upgradeProperty(idx, pos);
                    }, () => {
                        nextPlayer();
                    });
                } else {
                    addLog(`üè† ${p.name} Âà∞ËææËá™Â∑±ÁöÑÂú∞Áõò`);
                    showEventModal('üè†', 'Ëá™Â∑±ÁöÑÂú∞Áõò', `ËøôÊòØ ${p.name} ÁöÑÂú∞‰∫ß`, () => {
                        nextPlayer();
                    });
                }
            } else {
                const owner = players[prop.owner];
                if (owner.inJail) {
                    addLog(`üîí Âú∞‰∏ª ${owner.name} Âú®ÁõëÁã±ÔºåÂÖçÁßü`);
                    showEventModal('üîí', 'Âú∞‰∏ªÂú®ÁõëÁã±', `${owner.name} Âú®ÁõëÁã±‰∏≠ÔºåÂÖçÊî∂ÁßüÈáë`, () => {
                        nextPlayer();
                    });
                } else {
                    payRent(idx, pos);
                }
            }
        }

        function handleFacility(idx, pos) {
            const facility = board[pos];
            const p = players[idx];
            
            if (facility.owner === null) {
                if (p.money >= facility.price) {
                    showConfirm(`Ë¥≠‰π∞ ${facility.name}\n‰ª∑Ê†º: Ôø•${facility.price}`, () => {
                        buyFacility(idx, pos);
                    }, () => {
                        nextPlayer();
                    });
                } else {
                    addLog(`‚ùå ${p.name} ËµÑÈáë‰∏çË∂≥`);
                    showEventModal('‚ùå', 'ËµÑÈáë‰∏çË∂≥', `Êó†Ê≥ïË¥≠‰π∞ ${facility.name}`, () => {
                        nextPlayer();
                    });
                }
            } else if (facility.owner === idx) {
                if (pos === 35) {
                    const myProperties = p.properties.filter(propId => {
                        const prop = board[propId];
                        return prop.type === 'property' && prop.level < 3;
                    });
                    if (myProperties.length > 0) {
                        showModal('‚ö°', 'ÂèëÁîµÂéÇÁâπÊùÉ', 'ÈÄâÊã©ÂçáÁ∫ß‰∏ÄÂùóÂú∞‰∫ßÊàñÂèñÊ∂à', [
                            { type: 'modal-btn-confirm', text: 'ÂçáÁ∫ßÂú∞‰∫ß', callback: () => {
                                upgradeMode = true;
                                showEventModal('‚¨ÜÔ∏è', 'ÈÄâÊã©Âú∞‰∫ß', 'ÁÇπÂáª‰Ω†Ë¶ÅÂçáÁ∫ßÁöÑÂú∞‰∫ß', () => {
                                    renderBoard();
                                });
                            }},
                            { type: 'modal-btn-cancel', text: 'ÂèñÊ∂à', callback: () => {
                                nextPlayer();
                            }}
                        ]);
                    } else {
                        showEventModal('‚ö°', 'ÂèëÁîµÂéÇ', 'Ê≤°ÊúâÂèØÂçáÁ∫ßÁöÑÂú∞‰∫ß', () => {
                            nextPlayer();
                        });
                    }
                } else {
                    teleportMode = true;
                    showEventModal('üöÄ', 'ËÆæÊñΩÁâπÊùÉ', 'ÈÄâÊã©‰∏Ä‰∏™Âú∞Âùó‰º†ÈÄÅ', () => {
                        renderBoard();
                    });
                }
            } else {
                const owner = players[facility.owner];
                if (owner.inJail) {
                    addLog(`üîí Âú∞‰∏ª ${owner.name} Âú®ÁõëÁã±ÔºåÂÖçÁßü`);
                    showEventModal('üîí', 'Âú∞‰∏ªÂú®ÁõëÁã±', `${owner.name} Âú®ÁõëÁã±‰∏≠ÔºåÂÖçÊî∂ÁßüÈáë`, () => {
                        nextPlayer();
                    });
                } else {
                    payFacilityRent(idx, pos);
                }
            }
        }

        function buyFacility(idx, pos) {
            const p = players[idx];
            const facility = board[pos];
            
            p.money -= facility.price;
            p.properties.push(pos);
            facility.owner = idx;
            
            const spaceEl = document.querySelector(`[data-id="${pos}"]`);
            spaceEl.style.borderColor = p.color;
            spaceEl.style.borderWidth = '3px';
            
            addLog(`‚úÖ ${p.name} Ë¥≠‰π∞‰∫Ü ${facility.name}`);
            renderPlayers();
            updateCurrent();
            nextPlayer();
        }

        function payFacilityRent(idx, pos) {
            const facility = board[pos];
            const p = players[idx];
            const owner = players[facility.owner];
            
            let rent = facility.rent;
            
            if (hasFacilitySet(facility.owner)) {
                rent *= 2;
                addLog(`üé® ${owner.name} Êã•ÊúâÂÖ®ÈÉ®ËÆæÊñΩÔºåÁßüÈáëÁøªÂÄçÔºÅ`);
            }
            
            if (p.money >= rent) {
                p.money -= rent;
                owner.money += rent;
                addLog(`üí∏ ${p.name} Âêë ${owner.name} ÊîØ‰ªò Ôø•${rent} ÁßüÈáë`);
                showEventModal('üí∏', 'ÊîØ‰ªòÁßüÈáë', `Âêë ${owner.name} ÊîØ‰ªò Ôø•${rent}`, () => {
                    renderPlayers();
                    updateCurrent();
                    checkGameStatus();
                    nextPlayer();
                });
            } else {
                handleBankruptcy(idx);
            }
        }

        function buyProperty(idx, pos) {
            const p = players[idx];
            const prop = board[pos];
            
            p.money -= prop.price;
            p.properties.push(pos);
            prop.owner = idx;
            
            addLog(`‚úÖ ${p.name} Ë¥≠‰π∞‰∫Ü ${prop.name}`);
            renderPlayers();
            updateCurrent();
            renderBoard();
            nextPlayer();
        }

        function upgradeProperty(idx, pos) {
            const p = players[idx];
            const prop = board[pos];
            const upgradePrice = Math.floor(prop.price * 0.4);
            
            p.money -= upgradePrice;
            prop.level += 1;
            
            addLog(`‚¨ÜÔ∏è ${p.name} ÂçáÁ∫ß ${prop.name} Âà∞ Lv.${prop.level}`);
            renderPlayers();
            updateCurrent();
            renderBoard();
            nextPlayer();
        }

        function hasFullSet(idx, groupIdx) {
            const group = COLOR_GROUPS[groupIdx];
            if (!group || idx === null) return false;
            return group.ids.every(id => board[id].owner === idx);
        }

        function hasFacilitySet(idx) {
            return FACILITY_IDS.every(id => board[id].owner === idx);
        }

        function payRent(idx, pos) {
            const prop = board[pos];
            const p = players[idx];
            const owner = players[prop.owner];
            
            let rent = prop.rent[prop.level];
            
            if (hasFullSet(prop.owner, prop.group)) {
                rent *= 2;
                addLog(`üé® ${owner.name} Êã•ÊúâÊï¥Â•óÂú∞‰∫ßÔºåÁßüÈáëÁøªÂÄçÔºÅ`);
            }
            
            if (p.money >= rent) {
                p.money -= rent;
                owner.money += rent;
                addLog(`üí∏ ${p.name} Âêë ${owner.name} ÊîØ‰ªò Ôø•${rent} ÁßüÈáë`);
                showEventModal('üí∏', 'ÊîØ‰ªòÁßüÈáë', `Âêë ${owner.name} ÊîØ‰ªò Ôø•${rent}`, () => {
                    renderPlayers();
                    updateCurrent();
                    checkGameStatus();
                    nextPlayer();
                });
            } else {
                handleBankruptcy(idx);
            }
        }

        function handleBankruptcy(idx) {
            const p = players[idx];
            addLog(`üíî ${p.name} Á†¥‰∫ß‰∫ÜÔºÅ`);
            p.active = false;
            board.forEach((s, i) => {
                if (s.owner === idx) {
                    s.owner = null;
                    s.level = 0;
                }
            });
            showEventModal('üíî', 'Á†¥‰∫ß', `${p.name} Á†¥‰∫ß‰∫ÜÔºÅ`, () => {
                renderPlayers();
                updateCurrent();
                renderBoard();
                checkGameStatus();
                nextPlayer();
            });
        }

        function checkGameStatus() {
            const activePlayers = players.filter(p => p.active);
            
            if (activePlayers.length === 1) {
                showVictory(activePlayers[0]);
                return;
            }
            
            if (!finalCircleShown && activePlayers.length <= Math.ceil(players.length / 2) && activePlayers.length > 1) {
                finalCircleShown = true;
                showFinalCircle(activePlayers);
            }
        }

        function showFinalCircle(activePlayers) {
            const sorted = [...activePlayers].sort((a, b) => b.money - a.money);
            let rankText = 'ÂÜ≥ËµõÂúàÊéíÂêçÔºö\n\n';
            sorted.forEach((p, i) => {
                rankText += `${i + 1}. ${p.name} - Ôø•${p.money}\n`;
            });
            
            showEventModal('üî•', 'ÂÜ≥ËµõÂúàÔºÅ', rankText, () => {});
        }

        function showVictory(winner) {
            celebrate();
            setTimeout(() => {
                showEventModal('üéâ', 'Ê∏∏ÊàèËÉúÂà©ÔºÅ', `ÊÅ≠Âñú ${winner.name} Ëé∑ÂæóËÉúÂà©ÔºÅ\n\nÊÄªËµÑ‰∫ß: Ôø•${winner.money}\nÊã•ÊúâÂú∞‰∫ß: ${winner.properties.length} Â§Ñ`, () => {});
            }, 1000);
        }

        function celebrate() {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            document.body.appendChild(celebration);
            
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#F7DC6F', '#BB8FCE'];
            
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    celebration.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
            
            setTimeout(() => celebration.remove(), 4000);
        }

        function triggerEvent(idx, type) {
            const events = type === 'chance' ? CHANCE_EVENTS : DESTINY_EVENTS;
            const event = events[Math.floor(Math.random() * events.length)];
            const p = players[idx];
            
            if (event.type === 'money') {
                p.money += event.amount;
                addLog(`${event.amount > 0 ? 'üíµ' : 'üí∏'} ${p.name}: ${event.text}`);
                showEventModal(event.amount > 0 ? 'üí∞' : 'üí∏', type === 'chance' ? 'Êú∫‰ºöÂç°' : 'ÂëΩËøêÂç°', event.text, () => {
                    renderPlayers();
                    updateCurrent();
                    checkGameStatus();
                    nextPlayer();
                });
            } else if (event.type === 'move') {
                addLog(`üéØ ${p.name}: ${event.text}`);
                const newPos = (p.position + event.steps + board.length) % board.length;
                showEventModal('üéØ', type === 'chance' ? 'Êú∫‰ºöÂç°' : 'ÂëΩËøêÂç°', event.text, () => {
                    movePlayer(idx, newPos);
                });
            } else if (event.type === 'jail') {
                addLog(`üöî ${p.name}: ${event.text}`);
                showEventModal('üöî', type === 'chance' ? 'Êú∫‰ºöÂç°' : 'ÂëΩËøêÂç°', event.text, () => {
                    sendToJail(idx);
                });
            } else if (event.type === 'pass') {
                p.jailPass++;
                addLog(`üé´ ${p.name}: ${event.text}`);
                showEventModal('üé´', type === 'chance' ? 'Êú∫‰ºöÂç°' : 'ÂëΩËøêÂç°', event.text, () => {
                    renderPlayers();
                    updateCurrent();
                    nextPlayer();
                });
            } else if (event.type === 'teleport') {
                addLog(`‚ú® ${p.name}: ${event.text}`);
                showEventModal('‚ú®', type === 'chance' ? 'Êú∫‰ºöÂç°' : 'ÂëΩËøêÂç°', event.text, () => {
                    p.position = event.target;
                    updatePiecePos(p.id, event.target);
                    setTimeout(() => handleLanding(idx, event.target), 600);
                });
            } else if (event.type === 'chooseTeleport') {
                addLog(`‚ú® ${p.name}: ${event.text}`);
                teleportMode = true;
                showEventModal('‚ú®', type === 'chance' ? 'Êú∫‰ºöÂç°' : 'ÂëΩËøêÂç°', event.text, () => {
                    renderBoard();
                });
            } else if (event.type === 'repair') {
                const propertyCount = p.properties.filter(id => board[id].type === 'property').length;
                const cost = propertyCount * 200;
                p.money -= cost;
                addLog(`üîß ${p.name}: ${event.text} - ÊîØ‰ªò Ôø•${cost}`);
                showEventModal('üîß', type === 'chance' ? 'Êú∫‰ºöÂç°' : 'ÂëΩËøêÂç°', `${event.text}\nÂÖ± ${propertyCount} ‰∏™Âú∞Âùó\nÊîØ‰ªò Ôø•${cost}`, () => {
                    if (p.money < 0) {
                        handleBankruptcy(idx);
                    } else {
                        renderPlayers();
                        updateCurrent();
                        checkGameStatus();
                        nextPlayer();
                    }
                });
            } else if (event.type === 'chairman') {
                const activePlayers = players.filter(pl => pl.active && pl.id !== p.id);
                const cost = activePlayers.length * 500;
                p.money -= cost;
                activePlayers.forEach(pl => pl.money += 500);
                addLog(`üëî ${p.name}: ${event.text} - ÊîØ‰ªò Ôø•${cost}`);
                showEventModal('üëî', type === 'chance' ? 'Êú∫‰ºöÂç°' : 'ÂëΩËøêÂç°', `${event.text}\nÂêë ${activePlayers.length} ‰ΩçÁé©ÂÆ∂ÂêÑÊîØ‰ªò Ôø•500\nÂÖ±ÊîØ‰ªò Ôø•${cost}`, () => {
                    if (p.money < 0) {
                        handleBankruptcy(idx);
                    } else {
                        renderPlayers();
                        updateCurrent();
                        checkGameStatus();
                        nextPlayer();
                    }
                });
            } else if (event.type === 'birthday') {
                const activePlayers = players.filter(pl => pl.active && pl.id !== p.id);
                const income = activePlayers.length * 100;
                p.money += income;
                activePlayers.forEach(pl => pl.money -= 100);
                addLog(`üéÇ ${p.name}: ${event.text} - Êî∂Âèñ Ôø•${income}`);
                showEventModal('üéÇ', type === 'chance' ? 'Êú∫‰ºöÂç°' : 'ÂëΩËøêÂç°', `${event.text}\nÂêë ${activePlayers.length} ‰ΩçÁé©ÂÆ∂ÂêÑÊî∂Âèñ Ôø•100\nÂÖ±Êî∂Âèñ Ôø•${income}`, () => {
                    renderPlayers();
                    updateCurrent();
                    checkGameStatus();
                    nextPlayer();
                });
            } else if (event.type === 'nearestUtility') {
                const currentPos = p.position;
                const nearestUtility = findNearestUtility(currentPos);
                const utility = board[nearestUtility];
                
                addLog(`üöÄ ${p.name}: ${event.text}`);
                showEventModal('üöÄ', type === 'chance' ? 'Êú∫‰ºöÂç°' : 'ÂëΩËøêÂç°', event.text, () => {
                    p.position = nearestUtility;
                    updatePiecePos(p.id, nearestUtility);
                    
                    setTimeout(() => {
                        if (utility.owner === null) {
                            if (p.money >= utility.price) {
                                showConfirm(`Ë¥≠‰π∞ ${utility.name}\n‰ª∑Ê†º: Ôø•${utility.price}`, () => {
                                    buyFacility(idx, nearestUtility);
                                }, () => {
                                    nextPlayer();
                                });
                            } else {
                                showEventModal('‚ùå', 'ËµÑÈáë‰∏çË∂≥', 'Êó†Ê≥ïË¥≠‰π∞ËÆæÊñΩ', () => {
                                    nextPlayer();
                                });
                            }
                        } else if (utility.owner === idx) {
                            showEventModal('üè†', 'Ëá™Â∑±ÁöÑËÆæÊñΩ', 'ËøôÊòØ‰Ω†ÁöÑËÆæÊñΩ', () => {
                                nextPlayer();
                            });
                        } else {
                            const owner = players[utility.owner];
                            let rent = utility.rent;
                            
                            if (event.multiplier === 10) {
                                const dice1 = Math.floor(Math.random() * 6) + 1;
                                const dice2 = Math.floor(Math.random() * 6) + 1;
                                const total = dice1 + dice2;
                                rent = total * 10;
                                addLog(`üé≤ ÊäïÂá∫ ${dice1}+${dice2}=${total}ÔºåÁßüÈáë‰∏∫ Ôø•${rent}`);
                            } else if (event.multiplier === 2) {
                                rent *= 2;
                            }
                            
                            if (p.money >= rent) {
                                p.money -= rent;
                                owner.money += rent;
                                addLog(`üí∏ ${p.name} Âêë ${owner.name} ÊîØ‰ªò Ôø•${rent}`);
                                showEventModal('üí∏', 'ÊîØ‰ªòÁßüÈáë', `Âêë ${owner.name} ÊîØ‰ªò Ôø•${rent}`, () => {
                                    renderPlayers();
                                    updateCurrent();
                                    checkGameStatus();
                                    nextPlayer();
                                });
                            } else {
                                handleBankruptcy(idx);
                            }
                        }
                    }, 600);
                });
            }
        }

        function findNearestUtility(currentPos) {
            let nearest = FACILITY_IDS[0];
            let minDistance = Infinity;
            
            FACILITY_IDS.forEach(utilityPos => {
                let distance = (utilityPos - currentPos + board.length) % board.length;
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = utilityPos;
                }
            });
            
            return nearest;
        }

        function teleportToSpace(spaceId) {
            if (!teleportMode && !upgradeMode) return;
            
            if (teleportMode) {
                teleportMode = false;
                const p = players[currentIdx];
                p.position = spaceId;
                updatePiecePos(p.id, spaceId);
                addLog(`‚ú® ${p.name} ‰º†ÈÄÅÂà∞ ${board[spaceId].name}`);
                
                renderBoard();
                setTimeout(() => handleLanding(currentIdx, spaceId), 600);
            } else if (upgradeMode) {
                upgradeFromFoundation(spaceId);
            }
        }

        function nextPlayer() {
            let next = (currentIdx + 1) % players.length;
            let tries = 0;
            
            while (!players[next].active && tries < players.length) {
                next = (next + 1) % players.length;
                tries++;
            }
            
            currentIdx = next;
            
            document.getElementById('diceBtn').disabled = false;
            
            updateCurrent();
            renderPlayers();
        }

        function showModal(icon, title, text, buttons) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').textContent = text;
            
            const buttonsContainer = document.getElementById('modalButtons');
            buttonsContainer.innerHTML = '';
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `modal-btn ${btn.type}`;
                button.textContent = btn.text;
                button.onclick = () => {
                    modal.classList.remove('show');
                    if (btn.callback) btn.callback();
                };
                buttonsContainer.appendChild(button);
            });
            
            modal.classList.add('show');
        }

        function showAlert(text, callback) {
            showModal('‚ö†Ô∏è', 'ÊèêÁ§∫', text, [
                { type: 'modal-btn-confirm', text: 'Á°ÆÂÆö', callback }
            ]);
        }

        function showConfirm(text, onConfirm, onCancel) {
            showModal('‚ùì', 'Á°ÆËÆ§', text, [
                { type: 'modal-btn-confirm', text: 'Á°ÆËÆ§', callback: onConfirm },
                { type: 'modal-btn-cancel', text: 'ÂèñÊ∂à', callback: onCancel }
            ]);
        }

        function showEventModal(icon, title, text, callback) {
            showModal(icon, title, text, [
                { type: 'modal-btn-confirm', text: 'Á°ÆÂÆö', callback }
            ]);
        }

        function showPrompt(text, defaultValue, callback) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalIcon').textContent = '‚úèÔ∏è';
            document.getElementById('modalTitle').textContent = 'ËæìÂÖ•';
            
            const textEl = document.getElementById('modalText');
            textEl.innerHTML = `
                <div style="margin-bottom: 15px;">${text}</div>
                <input type="text" id="promptInput" value="${defaultValue}" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
            `;
            
            const buttonsContainer = document.getElementById('modalButtons');
            buttonsContainer.innerHTML = '';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'modal-btn modal-btn-confirm';
            confirmBtn.textContent = 'Á°ÆÂÆö';
            confirmBtn.onclick = () => {
                const value = document.getElementById('promptInput').value;
                modal.classList.remove('show');
                if (callback) callback(value);
            };
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'modal-btn modal-btn-cancel';
            cancelBtn.textContent = 'ÂèñÊ∂à';
            cancelBtn.onclick = () => {
                modal.classList.remove('show');
            };
            
            buttonsContainer.appendChild(confirmBtn);
            buttonsContainer.appendChild(cancelBtn);
            
            modal.classList.add('show');
            
            setTimeout(() => {
                const input = document.getElementById('promptInput');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('colorPickerModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target.id === 'colorPickerModal') {
                        modal.classList.remove('show');
                    }
                });
            }
            
            init();
        });
    </script>
    <!-- Created by Parsifals(Github: Parsifal-1) -->
</body>
</html>